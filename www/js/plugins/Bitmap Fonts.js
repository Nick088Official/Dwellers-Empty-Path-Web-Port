//=============================================================================
// TDS Bitmap Fonts
// Version: 1.6 (Web-Patched)
//=============================================================================
// Add to Imported List
var Imported = Imported || {} ; Imported.TDS_BitmapFonts = true;
// Initialize Alias Object
var _TDS_ = _TDS_ || {} ; _TDS_.BitmapFonts = _TDS_.BitmapFonts || {};
//=============================================================================
 /*:
 * @plugindesc
 * This plugin allows you to create and set images as fonts.
 * This plugin is made exclusively for Archeia and her projects.
 *
 * @author TDS
 *
 * @help
 * ============================================================================
 * * Text Codes
 * ============================================================================
 *
 *  This text code will allow you to set the bitmap font tone for
 *  messages:
 *
 *    \BC[red, green, blue]
 *
 *     (Red, Green, and Blue are values of strength from -255 to 255)
 *
 *    Example:
 *
 *    \BC[255,0,0]Show me some RED!\BC[]And Now back to normal.
 */
//=============================================================================
function BitmapFontManager(){throw new Error("This is a static class")}BitmapFontManager._fonts={},BitmapFontManager._isLoading=!1,BitmapFontManager._queue=[],BitmapFontManager._totalFiles=0,BitmapFontManager._loadedFiles=0,BitmapFontManager.isReady=function(){return!this._isLoading},BitmapFontManager.doesBitmapFontExist=function(t){return!!this._fonts[t]},BitmapFontManager.getFontData=function(t){return this._fonts[t]},BitmapFontManager.hexToRGB=function(t){return t=t.replace("#",""),[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]},BitmapFontManager.processAtlasData=function(t){for(var a={characters:{},bitmapName:t.meta.image.slice(0,-4)},e={_scx0:" ",_scx1:"\\",_scx2:"/",_scx3:":",_scx4:"*",_scx5:"?",_scx6:"<",_scx7:">",_scx8:"|",_scx9:".",_scx10:'"'},i=Object.keys(t.frames),r=0;r<i.length;r++){var o=i[r].slice(0,-4),s=t.frames[i[r]];e[o]?o=e[o]:2===o.length&&(o=o[0].toLowerCase()),a.characters[o]={},a.characters[o].rect=s.frame,a.characters[o].originalRect=s.spriteSourceSize,a.characters[o].sourceSize=s.sourceSize}return a},BitmapFontManager.makeBitmapFontObject=function(t,a,e){e=e||[];var i={name:t,size:a,color:e},r=this._fonts[t];if(r&&r.settings)for(var o=Object.keys(r.settings.fonts),s=0;s<o.length;s++){var n=o[s],l=r.settings.fonts[n],h=l.fontRange,c=l.forceTone;if(a>=h[0]&&a<=h[1]){if(i.atlas=r.atlases[n],e.length>0){var g=ImageManager.loadBitmapFontImage(t,i.atlas.bitmapName),p=new Bitmap(g.width,g.height);p.blt(g,0,0,g.width,g.height,0,0),c?p.forceTone(e[0],e[1],e[2]):p.adjustTone(e[0],e[1],e[2]),i.bitmap=p}else i.bitmap=ImageManager.loadBitmapFontImage(t,i.atlas.bitmapName);i.fontHeight=l.fontHeight,i.spaceWidth=l.spaceWidth;break}}return i},BitmapFontManager.loadAllBitmapFonts=function(){this._isLoading=!0,this._queue=["GameFont"],this.loadNextFontFromQueue()},BitmapFontManager.loadNextFontFromQueue=function(){if(0===this._queue.length)return void(this._isLoading=!1);var t=this._queue.shift(),a="fonts/Bitmap Fonts/"+t+"/Settings.json";this.loadJsonFile(t,"settings",a,this.onSettingsFileLoaded.bind(this))},BitmapFontManager.onSettingsFileLoaded=function(t,a,e){if(!e||!e.fonts)return console.error('Bitmap Fonts Error: Settings.json for font "'+t+'" is missing or malformed.'),void this.loadNextFontFromQueue();this._fonts[t]||(this._fonts[t]={settings:null,atlases:{}});var i=Object.keys(e.fonts);if(this._fonts[t].settings=e,this._totalFiles+=i.length,0===i.length)this.loadNextFontFromQueue();else for(var r=0;r<i.length;r++){var o=i[r];ImageManager.loadBitmapFontImage(t,o,0);var s="fonts/Bitmap Fonts/"+t+"/"+o+".json";this.loadJsonFile(t,o,s,this.onAtlasFileLoaded.bind(this))}},BitmapFontManager.onAtlasFileLoaded=function(t,a,e){this._fonts[t].atlases[a]=this.processAtlasData(e),this._loadedFiles++,this._loadedFiles>=this._totalFiles&&this.loadNextFontFromQueue()},BitmapFontManager.loadJsonFile=function(t,a,e,i){var r=new XMLHttpRequest;r.open("GET",e),r.overrideMimeType("application/json"),r.onload=function(){404===r.status?i(t,a,null):r.status<400?i(t,a,JSON.parse(r.responseText)):(console.error("Failed to load Bitmap Font file: "+e),i(t,a,null))},r.onerror=function(){console.error("Failed to load Bitmap Font file: "+e),i(t,a,null)},r.send()},ImageManager.loadBitmapFontImage=function(t,a,e){return this.loadBitmap("fonts/Bitmap Fonts/"+t+"/",a,e,!1)},_TDS_.BitmapFonts.Scene_Boot_initialize=Scene_Boot.prototype.initialize,Scene_Boot.prototype.initialize=function(){_TDS_.BitmapFonts.Scene_Boot_initialize.call(this),BitmapFontManager.loadAllBitmapFonts()},_TDS_.BitmapFonts.Scene_Boot_isReady=Scene_Boot.prototype.isReady,Scene_Boot.prototype.isReady=function(){return!!_TDS_.BitmapFonts.Scene_Boot_isReady.call(this)&&BitmapFontManager.isReady()},_TDS_.BitmapFonts.Bitmap_initialize=Bitmap.prototype.initialize,_TDS_.BitmapFonts.Bitmap_drawText=Bitmap.prototype.drawText,_TDS_.BitmapFonts.Bitmap_measureTextWidth=Bitmap.prototype.measureTextWidth,Bitmap.prototype.initialize=function(t,a){_TDS_.BitmapFonts.Bitmap_initialize.call(this,t,a),this._bitmapFont=null,this._useBitmapFont=!0,this._bitmapFontColor=null},Object.defineProperty(Bitmap.prototype,"bitmapFontColor",{get:function(){return this._bitmapFontColor},set:function(t){Array.isArray(t)?t.equals(this._bitmapFontColor)||(this._bitmapFontColor=t,this.updateBitmapFont()):this._bitmapFontColor!==t&&(this._bitmapFontColor=t,this.updateBitmapFont())},configurable:!0}),Bitmap.prototype.isUsingBitmapFont=function(){return this._useBitmapFont},Bitmap.prototype.measureTextWidth=function(t,a=!1){return this.isUsingBitmapFont()?this.measureBitmapFontText(t,a).width:_TDS_.BitmapFonts.Bitmap_measureTextWidth.call(this,t)},Bitmap.prototype.measureBitmapFontText=function(t,a=!1){a&&this.updateBitmapFont();var e={width:0,height:0},i=this._bitmapFont;if(i&&void 0!==t){e.height=i.fontHeight;for(var r=t.toString().split(""),o=0;o<r.length;o++){var s=i.atlas.characters[r[o]];e.width+=s?s.rect.w:i.spaceWidth}}return e},Bitmap.prototype.drawText=function(t,a,e,i,r,o){this.isUsingBitmapFont()?this.drawBitmapFontText(t,a,e,i,r,o):_TDS_.BitmapFonts.Bitmap_drawText.call(this,t,a,e,i,r,o)},Bitmap.prototype.updateBitmapFont=function(){if(BitmapFontManager.doesBitmapFontExist(this.fontFace))if(this._bitmapFont){var t=this._bitmapFont;t.name===this.fontFace&&t.size===this.fontSize&&t.color.equals(this._bitmapFontColor)||(this._bitmapFont=BitmapFontManager.makeBitmapFontObject(this.fontFace,this.fontSize,this._bitmapFontColor))}else this._bitmapFont=BitmapFontManager.makeBitmapFontObject(this.fontFace,this.fontSize,this._bitmapFontColor);else this._bitmapFont=null},Bitmap.prototype.drawBitmapFontText=function(t,a,e,i,r,o){this.updateBitmapFont();var s=this._bitmapFont;if(s&&void 0!==t){var n=s.bitmap,l=a,h=e+r-(r-.7*s.fontHeight)/2;if("center"===o)l+=(i-this.measureTextWidth(t))/2;if("right"===o)l+=i-this.measureTextWidth(t);for(var c=t.toString().split(""),g=0,p=0;p<c.length;p++){var B=c[p],F=s.atlas.characters[B];if(F){var _=F.sourceSize.h-s.fontHeight,f=F.rect,d=(r-s.fontHeight)/4,u=h-f.h+_+d;this.blt(n,f.x,f.y,f.w,f.h,l+g,u),g+=f.w}else g+=s.spaceWidth}}},Bitmap.prototype.forceTone=function(t,a,e){if((t||a||e)&&this.width>0&&this.height>0){for(var i=this._context,r=i.getImageData(0,0,this.width,this.height),o=r.data,s=0;s<o.length;s+=4)o[s+0]=t,o[s+1]=a,o[s+2]=e;i.putImageData(r,0,0),this._setDirty()}},_TDS_.BitmapFonts.Window_Base_resetFontSettings=Window_Base.prototype.resetFontSettings,_TDS_.BitmapFonts.Window_Base_processEscapeCharacter=Window_Base.prototype.processEscapeCharacter,Window_Base.prototype.resetFontSettings=function(){_TDS_.BitmapFonts.Window_Base_resetFontSettings.call(this),this.contents.updateBitmapFont()},Window_Base.prototype.obtainMultiEscapeParam=function(t){var a=/^\[([^\]]*)\]/.exec(t.text.slice(t.index)),e=[];return a&&(t.index+=a[0].length,e=eval(a[0])),e},Window_Base.prototype.processEscapeCharacter=function(t,a){switch(t){case"BC":var e=this.obtainMultiEscapeParam(a);this.contents.bitmapFontColor=this.obtainBitmapFontColor(e)}_TDS_.BitmapFonts.Window_Base_processEscapeCharacter.call(this,t,a)},Window_Base.prototype.obtainBitmapFontColor=function(t){return t.length>0?1===t.length?BitmapFontManager.hexToRGB(this.textColor(t[0])):t:null},Window_Base.prototype.processNormalCharacter=function(t){var a=t.text[t.index++],e=this.textWidth(a);this.contents.drawText(a,t.x,t.y,2*e,t.height),t.x+=e};